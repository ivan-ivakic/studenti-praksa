<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no'>
  <title>Hexis Icon Picker</title>
  <link href='css/iconPicker.css' media="screen" rel="stylesheet" type="text/css">
  <link href='css/icons.css' media="screen" rel="stylesheet" type="text/css">
  <script src='scripts/jquery.js'></script>
  <script src='scripts/react-with-addons.js'></script>
  <script src='scripts/JSXTransformer.js'></script>
</head>
<body>
<script type="text/jsx">


  var IconPicker = React.createClass({
    getInitialState: function() {
      return {
        icons: [],
        selected: [],
        missing: []
      };
    },

    componentDidMount: function() {
      $.ajax({
        url: "node_modules/hexis-commons/font-icon-picker/icons.json",
        dataType: 'json',
        success: function(data) {
          var icons = data;
          
          this.setState({
            icons: icons
          });
          
          // Now fetch user's selected icons
          $.ajax({
            url: "icons-selected.json",
            dataType: 'json',
            success: function(data) {

              var icons = this.state.icons;
              var missing = [];
              var data = data;

              data.forEach(function(item){
                if( icons.indexOf(item) === -1 ){
                  missing.push( item );
                }
              });

              missing.forEach(function(item){
                if( data.indexOf(item) > -1 ){
                  index = data.indexOf(item);
                  data.splice(index, 1);
                }
              });

              this.setState({
                selected: data,
                missing: missing
              });
            }.bind(this)
          });

        }.bind(this)
      });
    },

    updateSelected: function(data) {
      var index = this.state.selected.indexOf(data.name);
      if ( index > -1 ){
        var newState = React.addons.update(this.state.selected, { $splice: [[index, 1]] });
        this.setState({ selected: newState.sort() });
      } else {
        var newState = React.addons.update(this.state.selected, { $push: [data.name] });
        this.setState({ selected: newState.sort() });
      }
    },

    render: function() {
      return (
        <div className='iconPicker'>
          <IconList icons={this.state.icons} selected={this.state.selected} updateSelected={this.updateSelected} />
          <JsonList selected={this.state.selected} missing={this.state.missing} />
        </div>
      );
    }
  });


  var IconList = React.createClass({
    render: function() {
      var selected = this.props.selected;
      var updateSelected = this.props.updateSelected;
      var iconNodes = this.props.icons.map(function(name, index) {
        var isSelected = selected.indexOf(name) > -1;
        return (<Icon key={name} icon={name} isSelected={isSelected} updateSelected={updateSelected} />);
      });
      return (
        <ul ref='njesto' className="list">
          {iconNodes}
        </ul>
      );
    }
  });


  var Icon = React.createClass({
    getInitialState: function() {
      return {
        selected: this.props.isSelected
      };
    },
    render: function() {
      var selected = this.props.isSelected ? ' -selected' : '';
      var propagateChange = this.props.updateSelected.bind(null, {
        name: this.props.icon,
        key: this.props.id
      });
      return (
        <li className={'list_item' + selected} onClick={propagateChange}>
          <div className='list_item_image'>
            <i className={'icon -' + this.props.icon}></i>
          </div>
          <div className='list_item_class'>
            {this.props.icon}
          </div>
        </li>
      );
    }
  });


  var JsonList = React.createClass({
    render: function() {
      var value = JSON.stringify( this.props.selected );
      var selectedList = this.props.selected.map(function(icon, index) {
        return (
          <JsonItem key={icon} icon={icon} />
        );
      });
      var missingList = this.props.missing.map(function(icon, index) {
        return (
          <JsonItem key={icon} icon={icon} />
        );
      });
      return (
        <form className='jsonForm' action='/' method='post'>
          <textarea className='jsonForm_textarea' id='json' name='json' value={value} readOnly></textarea>
          <div className='outputPreview'>
            <div className='column selectedIcons'>
              <strong className='column_title'>Selected icons</strong>
              <pre>
                [
                  {selectedList}
                ]
              </pre>
            </div>
            <div className='column missingIcons'>
              <strong className='column_title'>Warning: These icons are outdated and will be removed when you click "Save changes".</strong>
              <pre>
                [
                  {missingList}
                ]
              </pre>
            </div>
          </div>
          <input className='jsonForm_submit' type='submit' value='Save changes' />
        </form>
      );
    }
  });


  var JsonItem = React.createClass({
    render: function() {
      return (
        <span className="selectedJSON_item">
          {'"' + this.props.icon + '",'}
        </span>
      );
    }
  });


  React.render(
    <IconPicker />,
    document.getElementById('content')
  );


</script>
<div id="content"></div>
</body>
</html>
